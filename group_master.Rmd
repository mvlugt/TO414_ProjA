---
title: "group_master"
author: "Michael Im, Michael Vander Lugt, Josh Horowitz, Don Chao, Evan Fisher"
date: "February 19, 2017"
output: 
  html_document: 
    theme: united
    toc: yes
    number_sections: TRUE
    toc_float:
      collapsed: FALSE
---

```{r}

temp <- tempfile()
download.file("https://s3.amazonaws.com/tripdata/201601-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201601-citibike-tripdata.csv")
data1 <- read.csv("201601-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201602-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201602-citibike-tripdata.csv")
data2 <- read.csv("201602-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201603-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201603-citibike-tripdata.csv")
data3 <- read.csv("201603-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201604-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201604-citibike-tripdata.csv")
data4 <- read.csv("201604-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201605-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201605-citibike-tripdata.csv")
data5 <- read.csv("201605-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201606-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201606-citibike-tripdata.csv")
data6 <- read.csv("201606-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201607-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201607-citibike-tripdata.csv")
data7 <- read.csv("201607-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201608-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201608-citibike-tripdata.csv")
data8 <- read.csv("201608-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201609-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201609-citibike-tripdata.csv")
data9 <- read.csv("201609-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201610-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201610-citibike-tripdata.csv")
data10 <- read.csv("201610-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201611-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201611-citibike-tripdata.csv")
data11 <- read.csv("201611-citibike-tripdata.csv")

download.file("https://s3.amazonaws.com/tripdata/201612-citibike-tripdata.zip",temp, mode="wb")
unzip(temp, "201612-citibike-tripdata.csv")
data12 <- read.csv("201612-citibike-tripdata.csv")

#determine how many rows to take for sample
#take random samples from all data sets
num.rows = nrow(data1) * 0.005
data1.small <- data1[sample(nrow(data1), round(num.rows)), ]

num.rows = nrow(data2) * 0.005
data2.small <- data2[sample(nrow(data2), round(num.rows)), ]

num.rows = nrow(data3) * 0.005
data3.small <- data3[sample(nrow(data3), round(num.rows)), ]

num.rows = nrow(data4) * 0.005
data4.small <- data4[sample(nrow(data4), round(num.rows)), ]

num.rows = nrow(data5) * 0.005
data5.small <- data5[sample(nrow(data5), round(num.rows)), ]

num.rows = nrow(data6) * 0.005
data6.small <- data6[sample(nrow(data6), round(num.rows)), ]

num.rows = nrow(data7) * 0.005
data7.small <- data7[sample(nrow(data7), round(num.rows)), ]

num.rows = nrow(data8) * 0.005
data8.small <- data8[sample(nrow(data8), round(num.rows)), ]

num.rows = nrow(data9) * 0.005
data9.small <- data9[sample(nrow(data9), round(num.rows)), ]

num.rows = nrow(data10) * 0.005
data10.small <- data10[sample(nrow(data10), round(num.rows)), ]

num.rows = nrow(data11) * 0.005
data11.small <- data11[sample(nrow(data11), round(num.rows)), ]

num.rows = nrow(data12) * 0.005
datasmall12 <- data12[sample(nrow(data12), round(num.rows)), ]


#merge all data

data.all <- merge(data1.small, data2.small, all = TRUE)
data.all <- merge(data.all, data3.small, all = TRUE)
data.all <- merge(data.all, data4.small, all = TRUE)
data.all <- merge(data.all, data5.small, all = TRUE)
data.all <- merge(data.all, data6.small, all = TRUE)##
data.all <- merge(data.all, data7.small, all = TRUE)
data.all <- merge(data.all, data8.small, all = TRUE)
data.all <- merge(data.all, data9.small, all = TRUE)
#data.all <- merge(data.all, data10.small, all = TRUE)
#data.all <- merge(data.all, data11.small, all = TRUE)
#data.all <- merge(data.all, data12.small, all = TRUE)


cb <- data.all


#need to separate the space in the starttime and endtime to get the time and date columns separate
#strsplit(x, " ")
x1 <- cb$starttime
x2 <- as.character(x1)
x2 <- c(x2)
x3 <- read.table(text = x2, sep = " ", colClasses = "character")
x4 <- x3$V1
x5 <- read.table(text = x4, sep = "/", colClasses = "character")
cb$starttime_date = paste(x5$V3, "-", x5$V1, "-", x5$V2, sep = "")
cb$month = x5$V1
cb$starttime_time = x3$V2 #times are in character now
cb$starttime_time = gsub(':', '', cb$starttime_time) #removes the ':' from times
cb$starttime_time = as.numeric(cb$starttime_time) #makes times numbers

#same thing for stoptime
x1 <- cb$stoptime
x2 <- as.character(x1)
x2 <- c(x2)
x3 <- read.table(text = x2, sep = " ", colClasses = "character")
x4 <- x3$V1
x5 <- read.table(text = x4, sep = "/", colClasses = "character")
cb$stoptime_date = paste(x5$V3, "-", x5$V1, "-", x5$V2, sep = "")
cb$stoptime_time = x3$V2 #times are in character now
cb$stoptime_time = gsub(':', '', cb$stoptime_time) #removes the ':' from times
cb$stoptime_time = as.numeric(cb$stoptime_time) #makes times numbers


##make new columns for time of day, day of week, month, season
#time of day:
calculateTime <- function(x) {
  if(x < 120000) {
    timeCategory <- "Morning"
  } else if(x < 170000) {
    timeCategory <- "Afternoon"
  } else if(x <= 240000) {
    timeCategory <- "Evening"
  }
  timeCategory
}
## create new column with time of day as factor
cb$timeCategory <- sapply(cb$starttime_time, calculateTime)
cb$timeCategory <- as.factor(cb$timeCategory)

#day of week column
cb$weekday = weekdays(as.Date(cb$starttime_date))

#season
calculateSeason <- function(x) {
  if(x < 3) {
    season <- "Winter"
  } else if(x < 6) {
    season <- "Spring"
  } else if(x < 9) {
    season <- "Summer"
  } else if(x <= 12) {
    season <- "Fall"
  }
  season
}
## create new column with time of day as factor
cb$month <- as.integer(cb$month)
cb$season <- sapply(cb$month, calculateSeason)
cb$season <- as.factor(cb$season)


write.csv(cb, file = "citibike_jan_sept_v1.csv")


```


```{r}
library(dplyr)
library(ggplot2)
library(data.table)
library(leaflet)
library(futile.logger)
library(grid)
library(VennDiagram)
library(knitr)
cb <- read.csv("citibike_jan_sept_v1.csv")

```

#Question 1

Please see below for an overview of the statistics discovered:

* The average trip duration is about 18 minutes
* The most popular station is Pershing Square North
* On average, females ride longer than males
* Gender is the only variable that can significantly predict a customer's ride duration


```{r}

##calculate stats

average.duration = mean(cb$tripduration)
median.duration = median(cb$tripduration)
shortest.duration = min(cb$tripduration)
longest.duration = max(cb$tripduration)

#make function for finding the most popular station
getmode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

pop.station = getmode(cb$start.station.name)

##print stats
cat(paste(" The average trip duration is: ", average.duration, " seconds\n",
      "The median trip duration is: ", median.duration, " seconds\n",
      "The shortest trip taken was: ", shortest.duration, " seconds\n",
      "The longest trip taken was: ", longest.duration, " seconds\n",
      "The most popular start station is: ", pop.station))


##summary stats of user demographics
count.male = nrow(subset(cb, gender == 1))
count.female = nrow(subset(cb, gender == 2))
count.unspecified = nrow(subset(cb, gender == 0))

##make pie chart showing gender breakdown
slices <- c(count.male, count.female, count.unspecified)
lbls <- c("Male", "Female", "Unspecified")
pie(slices, labels = lbls, main = "Rider Gender Breakdown")

##descriptive stats by gender
barplot(tapply(cb$tripduration, cb$gender, mean), names.arg = c("Unspecified", "Male", "Female"),ylim = c(0,2500), main="Trip Duration (seconds) by Reported Gender")

##linear regression
duration.large <- lm(cb$tripduration ~ cb$birth.year + cb$gender + cb$starttime_time + cb$season + cb$month + cb$weekday + cb$bikeid + cb$usertype)
summary(duration.large)
duration.refined <- lm(cb$tripduration ~ cb$gender)
summary(duration.refined)


```

#Question 2

Identify patterns in the ride history data. Explain these patterns using appropriate visualization. A few potential patterns are (this is an illustrative list, you should formulate your own patterns as well to be explored here):

* How does ride volume change with time of day, day of the week, month of year?
* Which stations see the most asymmetric traffic (more arrivals than departures and vice versa)? Does this change with time of day and day of the week?
* Which stations originate the longest rides? Does this change as we go through different times of the day?

##Ride Volume Data based on Time of Day (Q2a)

As you can see from the data, there are several peak times in the tide volume throughout a normal day. These peak times represent the morning and evening rush hours to and from work.

* Morning Rush - 8:00 AM to 10:00 AM (peaking at 9:00 AM)

* Evening Rush - 4:00 pm to 7:00 PM (peaking at 6:00 PM)

Also, note that average ride volume is the highest between the two rush hours (so in the afternoon), and there are very few bikers out between 10:00 PM and 6:00 AM.

```{r}

#function count number of start times and end times and then find difference
#TIME FUNCTION
ride_volume <- function(time, cb){
  volume <- nrow(subset(cb, cb$starttime_time <= time & cb$stoptime_time >= time))
  volume
}

cb_sample <- sample_n(cb, 50000)
hours <- c(10000,13000,20000,23000,30000,33000,40000,43000,50000,53000, 60000,63000,70000,73000,80000,83000,90000,93000,100000,103000,110000,113000,120000,123000,130000,133000,140000,143000,150000,153000,160000,163000,170000,173000,180000,183000,190000,193000,200000,203000,210000,213000,220000,223000,230000,233000,240000)
#hours <- c("1am","130am", "2am", "230am", "3am", "330am","4am", "430am", "5am", "530am","6am","630am", "7am","730am", "8am","830am", "9am","930am", "10am","1030am", "11am","1130am" ,"12pm","1230pm" ,"1pm", "130pm","2pm", "230pm","3pm", "330pm","4pm", "430pm","5pm", "530pm","6pm","630pm","7pm","730pm","8pm","830pm","9pm","930pm","10pm","1030pm","11pm","1130pm","12am")
volumes <- c(ride_volume(10000, cb_sample),  ride_volume(13000, cb_sample), ride_volume(20000, cb_sample), ride_volume(23000, cb_sample), ride_volume(30000, cb_sample), ride_volume(33000, cb_sample), ride_volume(40000, cb_sample), ride_volume(43000, cb_sample), ride_volume(50000, cb_sample), ride_volume(53000, cb_sample), ride_volume(60000, cb_sample), ride_volume(63000, cb_sample), ride_volume(70000, cb_sample),ride_volume(73000, cb_sample), ride_volume(80000, cb_sample), ride_volume(83000, cb_sample), ride_volume(90000, cb_sample), ride_volume(93000, cb_sample), ride_volume(100000, cb_sample),ride_volume(103000, cb_sample), ride_volume(110000, cb_sample), ride_volume(113000, cb_sample), ride_volume(120000, cb_sample), ride_volume(123000, cb_sample), ride_volume(130000, cb_sample), ride_volume(133000, cb_sample), ride_volume(140000, cb_sample), ride_volume(143000, cb_sample), ride_volume(150000, cb_sample), ride_volume(153000, cb_sample), ride_volume(160000, cb_sample),ride_volume(163000, cb_sample), ride_volume(170000, cb_sample), ride_volume(173000, cb_sample), ride_volume(180000, cb_sample), ride_volume(183000, cb_sample), ride_volume(190000, cb_sample), ride_volume(193000, cb_sample), ride_volume(200000, cb_sample),ride_volume(203000, cb_sample), ride_volume(210000, cb_sample), ride_volume(213000, cb_sample), ride_volume(220000, cb_sample), ride_volume(223000, cb_sample), ride_volume(230000, cb_sample),ride_volume(233000, cb_sample), ride_volume(240000, cb_sample))
hour_volume <- data.frame(hours, volumes)

ggplot(data = hour_volume, aes(x = hour_volume$hours, y = hour_volume$volumes)) + geom_line() + labs(title = "Ride Volume Throughout Average Day", x = "Time of Day", y = "Ride Volume (numbers of bikers)") + scale_x_continuous(breaks=seq(20000,240000,20000),labels=c( "2am","4am","6am", "8am", "10am","12pm","2pm", "4pm","6pm","8pm","10pm","12am")) + theme(axis.title.x = element_text(vjust=0))

```

##Ride Volume Data based on Day of the Week (Q2a)

It is clear that users are more likely to use bikes during the work week rather than the weekend. Therefore, problems such as shortage of bikes are more likely to occur during the work week (especially on days like Tuesday through Thursdays, which are more in the middle of the work week).

```{r}

#DAY OF THE WEEK
weekdays <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
cb$weekday <- as.character(cb$weekday)
ride_volume2 <- function(weekday1, cb){
  volume <- nrow(subset(cb, cb$weekday == weekday1))
  volume
}
volumes <- c(ride_volume2("Sunday", cb_sample),  ride_volume2("Monday", cb_sample), ride_volume2("Tuesday", cb_sample), ride_volume2("Wednesday", cb_sample), ride_volume2("Thursday", cb_sample), ride_volume2("Friday", cb_sample), ride_volume2("Saturday", cb_sample)) 
week_volume <- data.frame(weekdays, volumes)

op <- par(mar = c(8,5,5,1) + 0.1)
barplot(week_volume$volumes, names.arg = week_volume$weekdays, las=2, ylim = c(0,10000), ylab = "Ride Volume (numbers of bikers)", main = "Ride Volume Throughout Week" )
par(op)

```

##Ride Volume based on Season (Q2a)

Bikers will much more likely take bikes out during the summer. This is probably due to cold weather conditions that occur during the Fall and Winter. Another hypothesis is that bikers are more likely to take bikes out during the day, and summer and spring are generally defined as having long days and short nights compared to Winter and Fall months.

```{r}

#month
seasons <- c("Summer", "Spring", "Winter", "Fall")
ride_volume3 <- function(season1, cb){
  volume <- nrow(subset(cb, cb$season == season1))
  volume
}
volumes <- c(ride_volume3("Summer", cb_sample),  ride_volume3("Spring", cb_sample), ride_volume3("Winter", cb_sample), ride_volume3("Fall", cb_sample)) 
season_volume <- data.frame(seasons, volumes)
barplot(season_volume$volumes, names.arg = season_volume$seasons, las=2, ylim = c(0,25000), ylab = "Ride Volume (number of bikers)", main = "Ride Volume Throughout Seasons" )

```
##What is the most frequently used start and end stations? (Q2b)

* start station: Pershing Squre North; end station: Pershing Square North
```{r}

t <- table(cb$start.station.name)
w <- as.data.frame(t)
w[which.max(w$Freq),] 


t2 <- table(cb$end.station.name)
w2 <- as.data.frame(t2)
w2[which.max(w2$Freq),] 

```

##What is the most asymmetric start and end station? (Q2b)

The most assymetric start station is the station that has the greatest difference between start station frequency and end station frequency. In the output, the most asymmetric start station is the station with the highest positive number for "Freq_Dif". Similarly, the most assymetric end station is the station that has the greatest difference between end station frequency and start station frequency. In the output, the most end asymmetric station is the station with the highest negative number for "Freq_Dif". 

The most asymmetric start station is "Penn Station Valet". It has 98 more uses as a start station than as an end station. The most asymmetric end station is "Greenwhich Ave & 8 Ave". It has 75 more uses as an end station than as a start station.
```{r}

#finding most asymmetric stations 

w <- as.data.frame(w)
w2 <- as.data.frame(w2)


merged_w_w2 <- full_join(w,w2, by = "Var1")
merged_w_w2 <- as.data.frame(merged_w_w2)

#adds new column (Freq_dif)
merged_w_w2$Freq_dif <- merged_w_w2$Freq.x - merged_w_w2$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm <- merged_w_w2[which.max(merged_w_w2$Freq_dif),] 
most_start_asymm

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm <- merged_w_w2[which.min(merged_w_w2$Freq_dif),]
most_end_asymm

```


Below, there is a barplot showing the top 10 most assmyetric start stations. 
```{r, fig.height=10}

top_n <- function(dataFrame) {
  return(nrow(dataFrame) * .017)
}

#data frame of top 10 asymmetric start stations 
most_start_asymm_top10 <- merged_w_w2[order(merged_w_w2$Freq_dif, decreasing=TRUE)[1:top_n(merged_w_w2)],]

par(oma = c(10,0,0,0))

#plot of top 10 asymmetric start stations
barplot(most_start_asymm_top10$Freq_dif, names.arg = most_start_asymm_top10$Var1, col = c("slategray2", "slategray3", "slategray4"), las = 3, main = "Most Asymmetric Stations (Start Station > End Station)",  ylab = "# of times favoring start station usage over end station usage")

```

Below, there is a barplot showing the top 10 most assymetric end stations. As the y-axis gets more negative, asymmetry increases. 
```{r, fig.height=10}
#data frame of top 10 asymmetric end stations 
most_end_asymm_top10 <- merged_w_w2[order(merged_w_w2$Freq_dif, decreasing=F)[1:top_n(merged_w_w2)],]

#plot of top 10 asymmetric end stations

par(oma = c(10,0,0,0))

barplot(most_end_asymm_top10$Freq_dif, names.arg = most_end_asymm_top10$Var1, col = c("slategray2", "slategray3", "slategray4"), las = 2, main = "Most Asymmetric Stations (End Station > Start Station)", ylab = "# of times favoring end station usage over start station usage")


```

##Does station frequency change by time of day? - Morning / Afternon / Evening (Q2b)

As the data below shows, frequency of start and end stations does change with time of day. While "Pershing Square North" was the the frequently used start and end station overall, "Penn Station Valet" was the most frequently used start station in the morning and "Pershing Square North" was the most frequently used end station in the morning. Also, "E 17 St. & Broadway" is the most frequenrly used start station in the afternoon, and "West St & Chambers St" is most frequently used end station in the afternoon. Lastly, "Pershing Square North" is the most used start and end station in the evening.
```{r}

#morning data set 
data_morning <- subset(cb, cb$timeCategory == "Morning")
data_morning <- as.data.frame(data_morning)

#"Penn Station Valet" is most popular start station in the morning 
t_morning <- table(data_morning$start.station.name)
w_morning <- as.data.frame(t_morning)
w_morning[which.max(w_morning$Freq),]

#"Pershing Sqaure North is most popular end station in the morning"
t2_morning <- table(data_morning$end.station.name)
w2_morning <- as.data.frame(t2_morning)
w2_morning[which.max(w2_morning$Freq),] 


#afternoon data set
data_afternoon <- subset(cb, cb$timeCategory == "Afternoon")
data_afternoon <- as.data.frame(data_afternoon)

#"E 17 St. & Broadway" is most popular start station in the afternoon
t_afternoon <- table(data_afternoon$start.station.name)
w_afternoon <- as.data.frame(t_afternoon)
w_afternoon[which.max(w_afternoon$Freq),]

#"West St & Chambers St" is most popilar end station in the afternoon
t2_afternoon <- table(data_afternoon$end.station.name)
w2_afternoon <- as.data.frame(t2_afternoon)
w2_afternoon[which.max(w2_afternoon$Freq),] 


#evening data set 
data_evening <- subset(cb, cb$timeCategory == "Evening")
data_evening <- as.data.frame(data_evening)

#"Pershing Sqaure North" is most popular start station in the evening
t_evening <- table(data_evening$start.station.name)
w_evening <- as.data.frame(t_evening)
w_evening[which.max(w_evening$Freq),]

#"Pershing Square North" is most popular end station in the evening
t2_evening <- table(data_evening$end.station.name)
w2_evening <- as.data.frame(t2_evening)
w2_evening[which.max(w2_evening$Freq),] 

```

Below, there is a barplot of the most frequently used start station for each time of the day. As the plot shows, the time of day that has the overall most frequently used start station is the evening. 
```{r}

#start station frequency barplot by time of day
start_station_freqs_time_day <- rbind(w_morning[which.max(w_morning$Freq),], w_afternoon[which.max(w_afternoon$Freq),], w_evening[which.max(w_evening$Freq),])
start_station_freqs_time_day$TimeDay <- c("Morning", "Afternoon", "Evening")
barplot(start_station_freqs_time_day$Freq, names.arg = start_station_freqs_time_day$TimeDay, col = c("slategray2", "slategray3", "slategray4"), las = 1, main = "Most Frequently Used Start Station by Time of Day", xlab = "Time of Day", ylab = "Frequency")

```

Below, there is a barplot of the most frequently used end station for each time of the day. As the plot shows, the time of day that has the overall most frequently used end station is the evening.
```{r}

#end station frequency barplot by time of day
end_station_freqs_time_day <- rbind(w2_morning[which.max(w2_morning$Freq),], w2_afternoon[which.max(w2_afternoon$Freq),], w2_evening[which.max(w2_evening$Freq),])
end_station_freqs_time_day$TimeDay <- c("Morning", "Afternoon", "Evening")
barplot(end_station_freqs_time_day$Freq, names.arg = end_station_freqs_time_day$TimeDay, col = c("slategray2", "slategray3", "slategray4"), las = 1, main = "Most Frequently Used End Station by Time of Day", xlab = "Time of Day", ylab = "Frequency")

```


##Does station asymmetry change by time of day? - Morning / Afternoon / Evening (Q2b)

As the data below shows, start and end station asymmetry changes by time of day."Penn Station Valet" is the overall most asymmetric start station and "Greenwhich Ave & 8 Ave" is the overall most asymmetric end station. "Penn Station Valet" is the most asymmetric start station in the morning, while "W 52 St & 5 Ave" is the most asymmetric end station in the morning. "Penn Station Valet" is the most asymmetric start station in the afteroon, while "Centre St & Chambers St" is the most asymmetric end station in the afternoon. "W 52 St & 5 Ave" is the most asymmetric start station in the evening, while "	E 14 St & Avenue B" is the most asymmetric end station in the evening.
```{r}

#morning
w_morning <- as.data.frame(w_morning)
w2_morning <- as.data.frame(w2_morning)

merged_w_w2_morning <- full_join(w_morning,w2_morning, by = "Var1")
merged_w_w2_morning <- as.data.frame(merged_w_w2_morning)

#adds new column (Freq_dif)
merged_w_w2_morning$Freq_dif <- merged_w_w2_morning$Freq.x - merged_w_w2_morning$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_morning <- merged_w_w2_morning[which.max(merged_w_w2_morning$Freq_dif),] 
most_start_asymm_morning

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_morning <- merged_w_w2_morning[which.min(merged_w_w2_morning$Freq_dif),]
most_end_asymm_morning

#afternoon
w_afternoon <- as.data.frame(w_afternoon)
w2_afternoon <- as.data.frame(w2_afternoon)

merged_w_w2_afternoon <- full_join(w_morning,w2_afternoon, by = "Var1")
merged_w_w2_afternoon <- as.data.frame(merged_w_w2_afternoon)

#adds new column (Freq_dif)
merged_w_w2_afternoon$Freq_dif <- merged_w_w2_afternoon$Freq.x - merged_w_w2_afternoon$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_afternoon <- merged_w_w2_afternoon[which.max(merged_w_w2_afternoon$Freq_dif),] 
most_start_asymm_afternoon

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_afternoon <- merged_w_w2_afternoon[which.min(merged_w_w2_afternoon$Freq_dif),]
most_end_asymm_afternoon

#evening
w_evening <- as.data.frame(w_evening)
w2_evening <- as.data.frame(w2_evening)

merged_w_w2_evening <- full_join(w_evening,w2_evening, by = "Var1")
merged_w_w2_evening <- as.data.frame(merged_w_w2_evening)

#adds new column (Freq_dif)
merged_w_w2_evening$Freq_dif <- merged_w_w2_evening$Freq.x - merged_w_w2_evening$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_evening <- merged_w_w2_evening[which.max(merged_w_w2_evening$Freq_dif),] 
most_start_asymm_evening

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_evening <- merged_w_w2_evening[which.min(merged_w_w2_evening$Freq_dif),]
most_end_asymm_evening

```

Below, there is a barplot of the highest asymmetric start station for each time of day. As the barplot shows, the time of day with the highest start station asymmetry is the morning, and the the time of day with the lowest start startion asymmetry is the evening. 
```{r}

#barplot of most assymetric start station by time of day 
most_start_asymm_time_day <- rbind(most_start_asymm_morning, most_start_asymm_afternoon, most_start_asymm_evening)

most_start_asymm_time_day$time_of_day <- c("Morning", "Afternoon", "Evening")


barplot(most_start_asymm_time_day$Freq_dif, names.arg = most_start_asymm_time_day$time_of_day, col = c("slategray2", "slategray3", "slategray4"), las = 1, main = "Most Asymmetric Start Station by Time of Day", xlab = "Time of Day", ylab = "Asymmetry Count")

```

Below, there is a barplot of the highest asymmetric end station for each time of day. As the barplot suggests, end station asymmetry is the highest in the morning, second highest in the evening, and least in the afternoon. 
```{r}

#barplot of most assymetreic end station by time of day
most_end_asymm_time_day <- rbind(most_end_asymm_morning, most_end_asymm_afternoon, most_end_asymm_evening)

most_end_asymm_time_day$time_of_day <- c("Morning", "Afternoon", "Evening")


barplot(most_end_asymm_time_day$Freq_dif, names.arg = most_end_asymm_time_day$time_of_day, col = c("slategray2", "slategray3", "slategray4"), las = 1, main = "Most Asymmetric End Station by Time of Day", xlab = "Time of Day", ylab = "Asymmetry Count")

```

##Does start and end station frequency change by day of week? (Q2b)

As the data below shows, start and end station frequency change with some days of the week. "Pershing Square North" is the most frequently used start and end station overall. The most frequently used start station on Monday is "West St & Chambers St", while the most frequently used end station on Monday is "Pershing Square North". The most frequently used start and end station on Tuesday, Wednesday, Thursday,and Friday is "Pershing Square North". On Saturday, "West St & Chambers St" is the most frequently used start and end station. Lastly,  "W 21 St & 6 Ave is the most frequently used start station on Sunday and "Centre St & Chambers St" is the most frequently used end station on Sunday.
```{r}

#Monday data set 
data_monday <- subset(cb, cb$weekday == "Monday")
data_monday <- as.data.frame(data_monday)

#"West St & Chambers St" is most popular start station on Monday
t_monday <- table(data_monday$start.station.name)
w_monday <- as.data.frame(t_monday)
w_monday[which.max(w_monday$Freq),]

#"Pershing Square North"" is most popular end station on Monday
t2_monday <- table(data_monday$end.station.name)
w2_monday <- as.data.frame(t2_monday)
w2_monday[which.max(w2_monday$Freq),]

#Tuesday data set 
data_tuesday <- subset(cb, cb$weekday == "Tuesday")
data_tuesday <- as.data.frame(data_tuesday)

#"Pershing Square North" is most popular start station on Tuesday
t_tuesday <- table(data_tuesday$start.station.name)
w_tuesday <- as.data.frame(t_tuesday)
w_tuesday[which.max(w_tuesday$Freq),]


#"Pershing Sqaure North" is most popular end station on Tuesday
t2_tuesday <- table(data_tuesday$end.station.name)
w2_tuesday <- as.data.frame(t2_tuesday)
w2_tuesday[which.max(w2_tuesday$Freq),]


#Wedneday data set 
data_wed <- subset(cb, cb$weekday == "Wednesday")
data_wed <- as.data.frame(data_wed)

#"Pershing Square North" is most popular start station on Wednesday
t_wed <- table(data_wed$start.station.name)
w_wed <- as.data.frame(t_wed)
w_wed[which.max(w_wed$Freq),]

#"Pershing Sqaure North" is most popular end station on Wednesday
t2_wed <- table(data_wed$end.station.name)
w2_wed <- as.data.frame(t2_wed)
w2_wed[which.max(w2_wed$Freq),]

#Thurday data set 
data_thurs <- subset(cb, cb$weekday == "Thursday")
data_thurs <- as.data.frame(data_thurs)

#"Pershing Square North" is most popular start station on Thursday
t_thurs <- table(data_thurs$start.station.name)
w_thurs <- as.data.frame(t_thurs)
w_thurs[which.max(w_thurs$Freq),]

#"Pershing Square North" is most popular end station on Thursday
t2_thurs <- table(data_thurs$end.station.name)
w2_thurs <- as.data.frame(t2_thurs)
w2_thurs[which.max(w2_thurs$Freq),] 

#Friday data set 
data_fri <- subset(cb, cb$weekday == "Friday")
data_fri <- as.data.frame(data_fri)

#"Pershing Square North" is most popular start station on Friday
t_fri <- table(data_fri$start.station.name)
w_fri <- as.data.frame(t_fri)
w_fri[which.max(w_fri$Freq),]

#"Pershing Square North" is most popular end station on Friday
t2_fri <- table(data_fri$end.station.name)
w2_fri <- as.data.frame(t2_fri)
w2_fri[which.max(w2_fri$Freq),]

#Saturday data set 
data_sat <- subset(cb, cb$weekday == "Saturday")
data_sat <- as.data.frame(data_sat)

#"West St & Chambers St" is most popular start station on Saturday
t_sat <- table(data_sat$start.station.name)
w_sat <- as.data.frame(t_sat)
w_sat[which.max(w_sat$Freq),]

#"West St & Chambers St" is most popular end station on Saturday
t2_sat <- table(data_sat$end.station.name)
w2_sat <- as.data.frame(t2_sat)
w2_sat[which.max(w2_sat$Freq),]

#Sunday data set 
data_sun <- subset(cb, cb$weekday == "Sunday")
data_sun <- as.data.frame(data_sun)

#"W 21 St & 6 Ave" is most popular start station on Sunday
t_sun <- table(data_sun$start.station.name)
w_sun <- as.data.frame(t_sun)
w_sun[which.max(w_sun$Freq),]

#"Centre St & Chambers St" is most popular end station on Sunday
t2_sun <- table(data_sun$end.station.name)
w2_sun <- as.data.frame(t2_sun)
w2_sun[which.max(w2_sun$Freq),] 

```

Below, there are barplots of the most frequently used start station and end station for each day of the week. As the plots show, the day of the week that has the most frequently used start station is Thursday, and the day of the week that has the most frequently used end station is Tuesday. 
```{r}
#barplot of most frequent used start station for each day of week
start_station_freq_day_week <- rbind(w_monday[which.max(w_monday$Freq),], w_tuesday[which.max(w_tuesday$Freq),], w_wed[which.max(w_wed$Freq),], w_thurs[which.max(w_thurs$Freq),], w_fri[which.max(w_fri$Freq),], w_sat[which.max(w_sat$Freq),], w_sun[which.max(w_sun$Freq),])

start_station_freq_day_week$Day_of_Week <- c("Monday", "Tuesday", "Wed", "Thursday", "Friday", "Saturday", "Sunday")

barplot(start_station_freq_day_week$Freq, names.arg = start_station_freq_day_week$Day_of_Week, col = c("slategray2", "slategray3", "slategray4", "steelblue2", "steelblue3", "steelblue4", "lightblue4"), las = 1, main = "Frequency of Most Frequently Used Start Station \n for each Day of Week", xlab = "Day of Week", ylab = "Frequency")


#barplot of most frequent used end station for each day of week
end_station_freq_day_week <- rbind(w2_monday[which.max(w2_monday$Freq),], w2_tuesday[which.max(w2_tuesday$Freq),], w2_wed[which.max(w2_wed$Freq),], w2_thurs[which.max(w2_thurs$Freq),], w2_fri[which.max(w2_fri$Freq),], w2_sat[which.max(w2_sat$Freq),], w2_sun[which.max(w2_sun$Freq),])

end_station_freq_day_week$Day_of_Week <- c("Monday", "Tuesday", "Wed", "Thursday", "Friday", "Saturday", "Sunday")

barplot(end_station_freq_day_week$Freq, names.arg = end_station_freq_day_week$Day_of_Week, col = c("slategray2", "slategray3", "slategray4", "steelblue2", "steelblue3", "steelblue4", "lightblue4"), las = 1, main = "Frequency of Most Frequently Used End Station \n for each Day of Week", xlab = "Day of Week", ylab = "Frequency")
```

##Does Start and End Station Asymmetry change with the day of the week? (Q2b)

As the data shows, start and end station asymmetry change with the day of the week.The most asymmetric start station on Monday is "Grand Army Plaza & Central Park S", with 21 more uses as a start station than as an end station. The most asymmetric end station on Monday is "W 41 St & 8 Ave", with 18 more uses as an end station than as a start station.The most asymmetric start station on Tuesday is "Penn Station Valet", with 31 more uses as a start station than as an end station. The most asymmetric end station on Tuesday is "W 39 St & 9 Ave", with 24 more uses as an end station than as a start station.The most asymmetric start station on Wednesday is "W 42 St & Dyer Ave", with 26 more uses as a start station than as an end station. The most asymmetric end station on Wednesday is "Cleveland Pl & Spring St", with 24 more uses as an end station than as a start station.The most asymmetric start station on Thursday is "Pershing Square North", with 26 more uses as a start station than as an end station. The most asymmetric end station on Thursday is "Broadway & W 29 St", with 22 more uses as an end station than as a start station.The most asymmetric start station on Friday is "Broadway & W 29 St", with 18 more uses as a start station than as an end station. The most asymmetric end station on Friday is "W 41 St & 8 Ave", with 41 more uses as an end station than as a start station.The most asymmetric start station on Saturday is "Grand Army Plaza & Central Park S", with 17 more uses as a start station than as an end station. The most asymmetric end station on Saturday is "W 21 St & 6 Ave", with 19 more uses as an end station than as a start station.The most asymmetric start station on Sunday is "W 20 St & 11 Ave", with 16 more uses as a start station than as an end station. The most asymmetric end station on Sunday is "Centre St & Chambers St", with 21 more uses as an end station than as a start station.
```{r}

#monday
w_monday <- as.data.frame(w_monday)
w2_monday <- as.data.frame(w2_monday)


merged_w_w2_monday <- full_join(w_monday,w2_monday, by = "Var1")
merged_w_w2_monday <- as.data.frame(merged_w_w2_monday)

#adds new column (Freq_dif)
merged_w_w2_monday$Freq_dif <- merged_w_w2_monday$Freq.x - merged_w_w2_monday$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_monday <- merged_w_w2_monday[which.max(merged_w_w2_monday$Freq_dif),] 
most_start_asymm_monday

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_monday <- merged_w_w2_monday[which.min(merged_w_w2_monday$Freq_dif),]
most_end_asymm_monday

#tuesday
w_tuesday <- as.data.frame(w_tuesday)
w2_tuesday<- as.data.frame(w2_tuesday)


merged_w_w2_tuesday <- full_join(w_tuesday,w2_tuesday, by = "Var1")
merged_w_w2_tuesday <- as.data.frame(merged_w_w2_tuesday)

#adds new column (Freq_dif)
merged_w_w2_tuesday$Freq_dif <- merged_w_w2_tuesday$Freq.x - merged_w_w2_tuesday$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_tuesday <- merged_w_w2_tuesday[which.max(merged_w_w2_tuesday$Freq_dif),] 
most_start_asymm_tuesday

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_tuesday <- merged_w_w2_tuesday[which.min(merged_w_w2_tuesday$Freq_dif),]
most_end_asymm_tuesday

#wednesday
w_wed <- as.data.frame(w_wed)
w2_wed <- as.data.frame(w2_wed)


merged_w_w2_wed <- full_join(w_wed,w2_wed, by = "Var1")
merged_w_w2_wed <- as.data.frame(merged_w_w2_wed)

#adds new column (Freq_dif)
merged_w_w2_wed$Freq_dif <- merged_w_w2_wed$Freq.x - merged_w_w2_wed$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_wed <- merged_w_w2_wed[which.max(merged_w_w2_wed$Freq_dif),] 
most_start_asymm_wed

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_wed <- merged_w_w2_wed[which.min(merged_w_w2_wed$Freq_dif),]
most_end_asymm_wed 

#thursday
w_thurs <- as.data.frame(w_thurs)
w2_thurs <- as.data.frame(w2_thurs)


merged_w_w2_thurs <- full_join(w_thurs,w2_thurs, by = "Var1")
merged_w_w2_thurs <- as.data.frame(merged_w_w2_thurs)

#adds new column (Freq_dif)
merged_w_w2_thurs$Freq_dif <- merged_w_w2_thurs$Freq.x - merged_w_w2_thurs$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_thurs <- merged_w_w2_thurs[which.max(merged_w_w2_thurs$Freq_dif),] 
most_start_asymm_thurs

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_thurs <- merged_w_w2_thurs[which.min(merged_w_w2_thurs$Freq_dif),]
most_end_asymm_thurs

#friday
w_fri <- as.data.frame(w_fri)
w2_fri <- as.data.frame(w2_fri)


merged_w_w2_fri <- full_join(w_fri,w2_fri, by = "Var1")
merged_w_w2_fri <- as.data.frame(merged_w_w2_fri)

#adds new column (Freq_dif)
merged_w_w2_fri$Freq_dif <- merged_w_w2_fri$Freq.x - merged_w_w2_fri$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_fri <- merged_w_w2_fri[which.max(merged_w_w2_fri$Freq_dif),] 
most_start_asymm_fri

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_fri <- merged_w_w2_fri[which.min(merged_w_w2_fri$Freq_dif),]
most_end_asymm_fri

#sat
w_sat <- as.data.frame(w_sat)
w2_sat <- as.data.frame(w2_sat)


merged_w_w2_sat <- full_join(w_sat,w2_sat, by = "Var1")
merged_w_w2_sat <- as.data.frame(merged_w_w2_sat)

#adds new column (Freq_dif)
merged_w_w2_sat$Freq_dif <- merged_w_w2_sat$Freq.x - merged_w_w2_sat$Freq.y 
# negative numbers in Freq_diff means more returns then starts 


#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_sat <- merged_w_w2_sat[which.max(merged_w_w2_sat$Freq_dif),] 
most_start_asymm_sat

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_sat <- merged_w_w2_sat[which.min(merged_w_w2_sat$Freq_dif),]
most_end_asymm_sat

#sun
w_sun <- as.data.frame(w_sun)
w2_sun <- as.data.frame(w2_sun)


merged_w_w2_sun <- full_join(w_sun,w2_sun, by = "Var1")
merged_w_w2_sun <- as.data.frame(merged_w_w2_sun)

#adds new column (Freq_dif)
merged_w_w2_sun$Freq_dif <- merged_w_w2_sun$Freq.x - merged_w_w2_sun$Freq.y 
# negative numbers in Freq_diff means more returns then starts 

#returns max diff ---most asymmetric station in favor of starts (most starts - ends)
most_start_asymm_sun <- merged_w_w2_sun[which.max(merged_w_w2_sun$Freq_dif),] 
most_start_asymm_sun

#returns min diff --most asymmetric station in favor of ends (most ends - starts)
most_end_asymm_sun <- merged_w_w2_sun[which.min(merged_w_w2_sun$Freq_dif),]
most_end_asymm_sun

```

Below, there are barplots of stations with the largest start and end asymmetry for each day of the week. As the first the plot shows, the day with largest amount of start station asymmetry is Tuesday. As the second plot shows, the day with the most end station asymmety is Friday. 
```{r}

#barplot of most asymmetric start station by day of week 
most_start_asymm_day_week <- rbind(most_start_asymm_monday, most_start_asymm_tuesday, most_start_asymm_wed, most_start_asymm_thurs, most_start_asymm_fri, most_start_asymm_sat, most_start_asymm_sun)

most_start_asymm_day_week$Day_of_Week <- c("Monday", "Tuesday", "Wed", "Thursday", "Friday", "Saturday", "Sunday")

barplot(most_start_asymm_day_week$Freq_dif, names.arg = most_start_asymm_day_week$Day_of_Week, col = c("slategray2", "slategray3", "slategray4", "steelblue2", "steelblue3", "steelblue4", "lightblue4"), las = 1, main = "Most Asymmetric Start Station by Day of Week", xlab = "Day of Week", ylab = "Asymmetry Count") 


#barplot of most asymmetric end station by day of week 
most_end_asymm_day_week <- rbind(most_end_asymm_monday, most_end_asymm_tuesday, most_end_asymm_wed, most_end_asymm_thurs, most_end_asymm_fri, most_end_asymm_sat, most_end_asymm_sun)

most_end_asymm_day_week$Day_of_Week <- c("Monday", "Tuesday", "Wed", "Thursday", "Friday", "Saturday", "Sunday")

barplot(most_end_asymm_day_week$Freq_dif, names.arg = most_end_asymm_day_week$Day_of_Week, col = c("slategray2", "slategray3", "slategray4", "steelblue2", "steelblue3", "steelblue4", "lightblue4"), las = 1, main = "Most Asymmetric End Station by Day of Week", xlab = "Day of Week", ylab = "Asymmetry Count")


```

##Which stations originate the longest rides? Does this change as we go through different times of the day? (Q2c)

Below are the top 20 stations originating the longest trip durations, across all time frames.
```{r,echo=FALSE}
#Question 2 Part C

cb = as.data.frame(cb)

longrides <- tapply(cb$tripduration, cb$start.station.name, mean)
longrides2 <- tail(sort(longrides),20)
longrides2 = as.data.frame(longrides2)
rownamesall <- row.names(longrides2)


longridesmorning <- subset(cb,cb$timeCategory=="Morning")
longridesmorning2 <- tapply(longridesmorning$tripduration, longridesmorning$start.station.name, mean)
longridesmorning2 <- tail(sort(longridesmorning2),20)
longridesmorning2 = as.data.frame(longridesmorning2)
longridesmorning2$longridesmorning2 <- factor(longridesmorning2$longridesmorning2, levels = longridesmorning2$longridesmorning2[order(longridesmorning2$longridesmorning2)])
longridesmorning2$longridesmorning2 = as.numeric(longridesmorning2$longridesmorning2)
rownamesmorning <- row.names(longridesmorning2)

longridesevening <- subset(cb,cb$timeCategory=="Evening")
longridesevening2 <- tapply(longridesevening$tripduration, longridesevening$start.station.name, mean)
longridesevening2 <- tail(sort(longridesevening2),20)

longridesevening2 = as.data.frame(longridesevening2)
longridesevening2$longridesevening2 <- factor(longridesevening2$longridesevening2, levels = longridesevening2$longridesevening2[order(longridesevening2$longridesevening2)])
longridesevening2$longridesevening2 = as.numeric(longridesevening2$longridesevening2)
rownamesevening <- row.names(longridesevening2)

longridesafternoon <- subset(cb,cb$timeCategory=="Afternoon")
longridesafternoon2 <- tapply(longridesafternoon$tripduration, longridesafternoon$start.station.name, mean)
longridesafternoon2 <- tail(sort(longridesafternoon2),20)
View(longridesafternoon2)

longridesafternoon2 = as.data.frame(longridesafternoon2)
longridesafternoon2$longridesafternoon2 <- factor(longridesafternoon2$longridesafternoon2, levels = longridesafternoon2$longridesafternoon2[order(longridesafternoon2$longridesafternoon2)])
longridesafternoon2$longridesafternoon2 = as.numeric(longridesafternoon2$longridesafternoon2)
rownamesafternoon <- row.names(longridesafternoon2)

```

```{r,echo=FALSE}
#plotting graphs
op <- par(mar = c(5,15,5,1) + 0.1)
op2 <- par(mgp=c(2.5,1,0))

barplot(longrides2$longrides2, names.arg = rownamesall, las=1,horiz=TRUE, main= "Top 20 Longest Average \n Trip Durations by Station", xlab = "Average Trip Duration (1000s seconds)")
par(op)
par(op2)
```


```{r,echo=FALSE}
#data to calculate venn diagram below:
rownamesall = as.factor(rownamesall)
rownamesmorning = as.factor(rownamesmorning)
rownamesevening = as.factor(rownamesevening)
rownamesafternoon = as.factor(rownamesafternoon)

#morning and evening
morningNevening <- intersect(rownamesmorning,rownamesevening)
morningNevening = as.factor(morningNevening)
morningNevening2 <- nlevels(morningNevening)

#morning and afternoon
morningNafternoon <- intersect(rownamesmorning,rownamesafternoon)
morningNafternoon = as.factor(morningNafternoon)
morningNafternoon2 <- nlevels(morningNafternoon)
#morning and all
morningNall <- intersect(rownamesmorning,rownamesall)
morningNall = as.factor(morningNall)
morningNall2 <- nlevels(morningNall)

#evening and afternoon
eveningNafternoon <- intersect(rownamesevening,rownamesafternoon)
eveningNafternoon = as.factor(eveningNafternoon)
eveningNafternoon2 <- nlevels(eveningNafternoon)
#evening and all
eveningNall <- intersect(rownamesevening,rownamesall)
eveningNall = as.factor(eveningNall)
eveningNall2 <- nlevels(eveningNall)

#afternoon and all
afternoonNall <- intersect(rownamesafternoon,rownamesall)
afternoonNall = as.factor(afternoonNall)
afternoonNall2 <- nlevels(afternoonNall)


#morning, evening, and afternoon
MENA <- Reduce(intersect, list(rownamesmorning,rownamesevening,rownamesafternoon))
MENA = as.factor(MENA)
MENA2 <-nlevels(MENA)

#morning, evening, and all
MENAll <- Reduce(intersect, list(rownamesmorning,rownamesevening,rownamesall))
MENAll = as.factor(MENAll)
MENAll2 <- nlevels(MENAll)

#morning, afternoon, and all
MANAll <- Reduce(intersect, list(rownamesmorning,rownamesafternoon,rownamesall))
MANAll = as.factor(MANAll)
MANAll2 <- nlevels(MANAll)
#evening, afternoon, and all
EANAll <- Reduce(intersect, list(rownamesevening,rownamesafternoon,rownamesall))
EANAll = as.factor(EANAll)
EANAll2 <- nlevels(EANAll)

#all 4
ALLFOUR <-Reduce(intersect, list(rownamesmorning,rownamesevening,rownamesafternoon,rownamesall))
ALLFOUR = as.factor(ALLFOUR)
ALLFOUR2 <- nlevels(ALLFOUR)

#morning only
morningonly <- 20-morningNall2-morningNevening2 - morningNafternoon2 - MENA2 - MENAll2 - MANAll2 - ALLFOUR2
#evening only
eveningonly <- 20-morningNevening2 - eveningNafternoon2 - eveningNall2 - MENA2 - MENAll2 - EANAll2- ALLFOUR2
#afternoon only
afternoononly <- 20 - morningNafternoon2 - eveningNafternoon2 - afternoonNall2 - MENA2 - MANAll2-EANAll2- ALLFOUR2
#all only
allonly <- 20- morningNall2 - eveningNall2 - afternoonNall2 - MENAll2 - MANAll2 - EANAll2- ALLFOUR2
```

This Venn diagram displays the overlaps between top 20 stations originating the longest trip druations, across time frames. We can clearly see that the top 20 stations changes significantly as the time of day changes.

Some stations are only within the top 20 busiest stations list during a designated time frame (e.g., morning, evening, afternoon), whereas other stations are busy across multiple time frames (e.g., morning and afternoon). No stations are in the top 20 busiest stations list for the entire day (i.e., morning to afternoon to evening.
```{r,echo=FALSE}
venn.plot <- draw.quad.venn(20, 20, 20, 20, morningNafternoon2, morningNevening2, morningNall2, eveningNafternoon2, afternoonNall2,
eveningNall2, MENA2, MANAll2, MENAll2, EANAll2, ALLFOUR2, category = c("Morning","Afternoon", "Evening", "All"), lwd = rep(2, 4), lty = rep("solid", 4), col =
rep("black", 4), fill = c("blue","red","green","yellow"), alpha = rep(0.5, 4),
label.col = rep("black", 15), cex = rep(1, 15),
fontface = rep("bold", 15), fontfamily = rep("serif",
15), cat.pos = c(-15, 15, 0, 0), cat.dist = c(0.22,
0.22, 0.11, 0.11), cat.col = rep("black", 4), cat.cex
= rep(1, 4), cat.fontface = rep("bold", 4),
cat.fontfamily = rep("serif", 4), cat.just =
rep(list(c(0.5, 0.5)), 4), rotation.degree = 0,
rotation.centre = c(0.5, 0.5), ind = TRUE, cex.prop =
NULL, print.mode = "raw", sigdigs = 3, direct.area =
FALSE, area.vector = 0)
```



Below we can compare the specific stations comprising the top 20 stations originating the longest rides, in each time frame.
```{r,echo=FALSE}
rownamesall <- rownamesall[order(rownamesall)]
rownamesmorning <- rownamesmorning[order(rownamesmorning)]
rownamesafternoon <- rownamesafternoon[order(rownamesafternoon)]
rownamesevening <- rownamesevening[order(rownamesevening)]

toptimesdf <- data.frame(rownamesall,rownamesmorning,rownamesafternoon, rownamesevening)

names(toptimesdf)[names(toptimesdf)=="rownamesall"] <- "All data"
names(toptimesdf)[names(toptimesdf)=="rownamesmorning"] <- "Morning data"
names(toptimesdf)[names(toptimesdf)=="rownamesevening"] <- "Evening data"
names(toptimesdf)[names(toptimesdf)=="rownamesafternoon"] <- "Afternoon data"



toptimestable <-kable(toptimesdf, format = "markdown")

toptimestable
#NEED TO VERIFY THESE NUMBERS
```

In the below barcharts, we can see that the top 20 stations originating the longest trip durations generate similar distributions in average trip duration.


```{r,echo=FALSE}
op <- par(mar = c(5,15,5,1) + 0.1)
op2 <- par(mgp=c(2.5,1,0))

barplot(longridesmorning2$longridesmorning2, names.arg = rownamesmorning, las=1, horiz=TRUE, main="Top 20 Longest Average Morning \n Trip Durations by Station", xlab="Average Trip Duration (1000s seconds)")

barplot(longridesevening2$longridesevening2, names.arg = rownamesevening, las=1, horiz=TRUE, main="Top 20 Longest Average Evening \n Trip Durations by Station", xlab="Average Trip Duration (1000s seconds)")

barplot(longridesafternoon2$longridesafternoon2, names.arg = rownamesafternoon, las=1, horiz=TRUE, main="Top 20 Longest Average Afternoon \n Trip Durations by Station", xlab="Average Trip Duration (1000s seconds)")
par(op)
par(op2)

```

##Popular Start and Stop Stations For Subscribers vs Customers (Q2d)

Ours graphs indicate that at least 10% of the stations have a substantial difference between subscribers versus customers. For both start station and end station, Pershing Square North has the largest difference at 60. We recommend focusing efforts around improving subscriber experience at these stations that attract more subscribers than customers. 


```{r}

findDifference <- function(sub, cus, searchId) {
  newDf <- data.frame()
  for(stationName in levels(sub[,searchId])) {
    if (stationName %in% cus[,searchId]) {
      dif <- nrow(subset(sub, sub[,searchId] == stationName)) - nrow(subset(cus, cus[,searchId] == stationName))
      newDf <- rbind(newDf, data.frame(stationName, dif))
    }
  }
  return(newDf)
}

top_n <- function(dataFrame) {
  return(nrow(dataFrame) * .1)
}

cb$routes <- as.factor(paste(cb$start.station.name, cb$end.station.name, sep="+"))
customer <- subset(cb, cb$usertype == "Customer")
subscriber <- subset(cb, cb$usertype == "Subscriber")

startDifferences <- findDifference(subscriber, customer, "start.station.name")
endDifferences <- findDifference(subscriber, customer, "end.station.name")

topStartDifferences <- startDifferences[order(startDifferences$dif,decreasing=T)[1:top_n(startDifferences)],]
topEndDifferences <- endDifferences[order(endDifferences$dif,decreasing=T)[1:top_n(endDifferences)],]

ggplot(data=topStartDifferences, aes(x=stationName, y=dif)) +
  geom_bar(stat="identity", width=0.5) + coord_flip() + labs(x="Station Name",y="Difference") + ggtitle("Subscribers vs. Customers at Start Stations")
ggplot(data=topEndDifferences, aes(x=stationName, y=dif)) +
  geom_bar(stat="identity", width=0.5) + coord_flip() + labs(x="Station Name",y="Difference") + ggtitle("Subscribers vs. Customers at End Stations")


```

##Linear Regression of Ride Duration Based on Age (Q2e)

TO DO: WRITEUP OF INSIGHTS

We considered a simple linear regression to predict trip duration based on age. 
```{r}
#Question 2 Part E

#Linear regression with ride duration being the dependent variable
cb$age <- (2017 - cb$birth.year)
rideDur <- lm(cb$tripduration ~ cb$age)
df <- data.frame(age = cb$age, dur = cb$tripduration)

ggplot(df, aes(x=age, y=dur)) +
    geom_point(shape=1) +  geom_smooth(method=lm, se=FALSE) + ylim(0, 15000) + xlim(18, 85)

rideDur <- lm(cb$tripduration ~ cb$age)
summary(rideDur)
```


#Question 3

Visualize the data to get a better sense of their dataset. Two potential visualizations include (again - an illustrative list - you should formulate and add your own visualizations; even though the list below only mentions maps, you need not limit yourself to maps - other graphics are welcome too)

* Show popular stations/routes on the map
* Show stations with a surplus (more arrivals than departures) and deficit (more departures than arrivals) on a map so that any geographical clustering of these stations can be visually seen.

##Popularity of Bikes by Region

###How Visual Works

* Numbers in Circles = Each number represents the number of users who have taken a bike in that region
  + Hovering over that region allows you to see the outline of the region in question.
  + Clicking that region will segment that region to give you sub-regions (you can repeat that process by clicking those regions).
  
###Insights from Map

* We invite you to keep interacting with this map to find useful data on which regions are the most popular.
  + Obvious trend that Downtown and Midtown have the most traffic while Brooklyn and Queens had less.

```{r}

library(leaflet)

cb_sample <- sample_n(cb, 5000)

leaflet(data = cb_sample) %>% addTiles() %>%
  addMarkers(~cb_sample$end.station.longitude, ~cb_sample$start.station.latitude, popup = ~cb_sample$start.station.name, clusterOptions = markerClusterOptions()) %>%   addProviderTiles("CartoDB.Positron")

#NEED TO DOUBLE CHECK THIS GRAPH, SEE IF WE CAN GET A BETTER ONE FROM THIS

```

#Question 4

While the client wants you to not limit your approach, they are particularly troubled by the following business issues and look forward to any insights on these issues:

* Stations running out of bikes is a big problem. Client would want to know which stations are candidates for increasing bike storage capacity.
* Bike maintenance bills are piling up. Client thinks that this is because some bikes are being used a lot more than other bikes. Can you check on this assumption?

##Popular and Unpopular Stations

###How Visual Works

* Radius of the circle = How many subscribers took out bikes from that station during the year
  + Bigger the radius means more subscribers are taking out bikes
* Clicking the circle
  + Shows what station you are looking at
  + Gives number of subscribers from sample that took out bikes from that station
  
###Insights from Map

* There are several stations, mainly thoughout downtown and midtown that seem to attract most of the subscribers.
  + These are the stations most likely to suffer from heightened maintainence and capacity problems.
  + Recommend cycling bikes from less popular stations to avoid maintainence issues along with increasing capacity at certain stations in MidTown and Downntown
* Most of the unpopular stations are grouped in Uptown, byt the coastline across Midtown and Downtown, and in Brooklyn/Queens.
  + Recommend higher advertising in those areas to stimulate demands.
  + Suggest closing several very unpopular stops to efficiently relocate supply to more popular stations.


```{r}

cb_sample <- sample_n(cb, 50000)

subscribers <- subset(cb_sample, cb_sample$usertype == "Subscriber")
subscribers$subscriber <- 1
subscriber_count <- data.frame(tapply(subscribers$subscriber, subscribers$start.station.name, sum))

subscriber_count <- na.omit(subscriber_count)
names <- rownames(subscriber_count)
rownames(subscriber_count) <- NULL
subscriber_count <- cbind(names, subscriber_count)
colnames(subscriber_count) <- c("station.name", "subscribers")

subscriber_count$lat <- cb_sample$start.station.latitude[subscriber_count$station.name]
subscriber_count$lng <- cb_sample$start.station.longitude[subscriber_count$station.name]


leaflet(subscriber_count) %>% addTiles() %>%
  addCircles(lng = ~subscriber_count$lng, lat = ~subscriber_count$lat, weight = 1,
    radius = ~subscriber_count$subscribers, popup = paste(subscriber_count$station.name, "<br/>", "Subscribers: ",subscriber_count$subscribers)
  ) %>%   addProviderTiles("CartoDB.Positron")

```

##Are Certain Bikes Used More?

Yes - there is quite a large range between usage by specific bike.

```{r}
##isolate bike ids
cb$bikeid <- as.factor(cb$bikeid)
bike <- unique(cb$bikeid)

bikedata <- data.frame(bike)

library(dplyr)
set.seed(1)
bikedata <- data.frame(ID = cb$bikeid)
bikedata <- bikedata %>% group_by(ID) %>% summarise(no_rows = length(ID))



##display data
barplot(bikedata$no_rows)

boxplot(bikedata$no_rows, horizontal = TRUE, xlab="Number of Uses", main="Uses per Bike")

```

##Are Most Bikes Returned to Their Start Station?

No - in fact, 98% of bikes are returned to a different station

```{r}
#count number of times bike is returned to start station
sameStation = nrow(cb[cb$start.station.id == cb$end.station.id ,])
differentStation = nrow(cb) - sameStation

#display data
slices <- c(sameStation, differentStation)
lbls <- c("Same Station", "Different Station")
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct)
lbls <- paste(lbls,"%",sep="")
pie(slices, labels = lbls, main = "Bikes Returned to Same vs. Different Station")

```




#Question 5

The following graphs and visualizations are to add more data to enhance any future business management strategies Citibike would like to execute in the near future.

##Stations with the Longest Commuters

###How Visual Works

* Radius of the circle = Average duration of a biker who starts their route from that station
  + Bigger the radius means the subscriber is taking the bike for longer periods of time (therefore, longer commutes on average)
* Clicking the circle
  + Shows what station you are looking at
  + Gives average duration of rider
  
###Insights from Map

* Two stations seem to be the typical station used for the longest commutes:
  + Hope St & Union Ave
  + Clinton St & Tillary St
* There are multiple stations that also seem to be good spots for commuting with many of them appearing close to the water.
* Most of the stations in the heart of Downtown and Midtown appear to be places where people take out bikes to move only for a few blocks.

```{r}

cb_sample <- sample_n(cb, 50000)

duration_averages <- data.frame(tapply(cb_sample$tripduration, cb_sample$start.station.name, mean, na.rm = TRUE))
duration_averages <- na.omit(duration_averages)
names <- rownames(duration_averages)
rownames(duration_averages) <- NULL
duration_averages <- cbind(names, duration_averages)
colnames(duration_averages) <- c("station.name", "average.duration")
duration_averages$lat <- cb_sample$start.station.latitude[duration_averages$station.name]
duration_averages$lng <- cb_sample$start.station.longitude[duration_averages$station.name]

leaflet(duration_averages) %>% addTiles() %>%
  addCircles(lng = ~duration_averages$lng, lat = ~duration_averages$lat, weight = 1,
    radius = ~duration_averages$average.duration/median(duration_averages$average.duration) * 100, popup =  paste(duration_averages$station.name, "<br/>", "Average Trip Duration: ", duration_averages$average.duration, " seconds")
  ) %>%   addProviderTiles("CartoDB.Positron")


```


###Insights from Map #2

* Red dots indicate stations with more arrivals than departures; Blue dots represent stations with more departures than arrivals.
* The difference in departures versus arrivals seems to be fairly evenly distributed across stations.
* However, a few stations that stand out are W 13th & 6th Avenue, which has significantly more bike arrivals and departures, and W 31st & 9thStreet, which has more bike departures than arrivals. These differences can be inferred from the circle radius size.
* We would suggest that these stations with higher arrival or departure counts be marked as high traffic areas and be provided more bikes or another docking rack.


```{r}
top_n <- function(dataFrame) {
  #Default to 20%
  return(nrow(dataFrame) * .2)
}
color <- function(val) {
  return(ifelse(val>=0,"navy","red"))
}

t <- table(cb$start.station.name)
w <- as.data.frame(t)
t2 <- table(cb$end.station.name)
w2 <- as.data.frame(t2)
t3 <- table(cb$start.station.latitude)
w3 <- as.data.frame(t3)

merged_w_w2 <- full_join(w,w2, by = "Var1")
colnames(merged_w_w2) <- c("start.station.name", "Freq.x", "Freq.y")
merged_w_w2 <- as.data.frame(merged_w_w2)
merged_w_w2$Freq_dif <- merged_w_w2$Freq.x - merged_w_w2$Freq.y

mergedWithLat <- merge(merged_w_w2, cb, by = intersect("start.station.name", "start.station.name"))
mergedWithLat["color"] <- color(mergedWithLat$Freq_dif)

leaflet(mergedWithLat) %>% addTiles() %>%
  addCircles(lng = ~mergedWithLat$start.station.longitude, lat = ~mergedWithLat$start.station.latitude, weight = 1,
    radius = ~abs(mergedWithLat$Freq_dif)/2, popup = ~mergedWithLat$Freq_dif, color = ~mergedWithLat$color
  ) %>%   addProviderTiles("CartoDB.Positron")

```





