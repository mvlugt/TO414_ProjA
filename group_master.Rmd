---
title: "group_master"
author: "Michael Im"
date: "February 19, 2017"
output:  html_document
---

```{r}
library(dplyr)
library(ggplot2)
library(data.table)
library(leaflet)
library(futile.logger)
library(grid)
library(knitr)
library(VennDiagram)
cb <- read.csv("citibike_jan_sept_v1.csv")

```

#Question 1

```{r}

##calculate stats

average.duration = mean(cb$tripduration)
median.duration = median(cb$tripduration)
shortest.duration = min(cb$tripduration)
longest.duration = max(cb$tripduration)

#make function for finding the most popular station
getmode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

pop.station = getmode(cb$start.station.name)

##print stats
cat(paste(" The average trip duration is: ", average.duration, " seconds\n",
      "The median trip duration is: ", median.duration, " seconds\n",
      "The shortest trip taken was: ", shortest.duration, " seconds\n",
      "The longest trip taken was: ", longest.duration, " seconds\n",
      "The most popular start station is: ", pop.station))


##summary stats of user demographics
count.male = nrow(subset(cb, gender == 1))
count.female = nrow(subset(cb, gender == 2))
count.unspecified = nrow(subset(cb, gender == 0))

##make pie chart showing gender breakdown
slices <- c(count.male, count.female, count.unspecified)
lbls <- c("Male", "Female", "Unspecified")
pie(slices, labels = lbls, main = "Rider Gender Breakdown")

##descriptive stats by gender
barplot(tapply(cb$tripduration, cb$gender, mean), names.arg = c("Unspecified", "Male", "Female"),ylim = c(0,2500), main="Trip Duration (seconds) by Reported Gender")



```

#Question 2

```{r}

#function count number of start times and end times and then find difference
#TIME FUNCTION
ride_volume <- function(time, cb){
  volume <- nrow(subset(cb, cb$starttime_time <= time & cb$stoptime_time >= time))
  volume
}

cb_sample <- sample_n(cb, 5000)
hours <- c(10000,13000,20000,23000,30000,33000,40000,43000,50000,53000, 60000,63000,70000,73000,80000,83000,90000,93000,100000,103000,110000,113000,120000,123000,130000,133000,140000,143000,150000,153000,160000,163000,170000,173000,180000,183000,190000,193000,200000,203000,210000,213000,220000,223000,230000,233000,240000)
#hours <- c("1am","130am", "2am", "230am", "3am", "330am","4am", "430am", "5am", "530am","6am","630am", "7am","730am", "8am","830am", "9am","930am", "10am","1030am", "11am","1130am" ,"12pm","1230pm" ,"1pm", "130pm","2pm", "230pm","3pm", "330pm","4pm", "430pm","5pm", "530pm","6pm","630pm","7pm","730pm","8pm","830pm","9pm","930pm","10pm","1030pm","11pm","1130pm","12am")
volumes <- c(ride_volume(10000, cb_sample),  ride_volume(13000, cb_sample), ride_volume(20000, cb_sample), ride_volume(23000, cb_sample), ride_volume(30000, cb_sample), ride_volume(33000, cb_sample), ride_volume(40000, cb_sample), ride_volume(43000, cb_sample), ride_volume(50000, cb_sample), ride_volume(53000, cb_sample), ride_volume(60000, cb_sample), ride_volume(63000, cb_sample), ride_volume(70000, cb_sample),ride_volume(73000, cb_sample), ride_volume(80000, cb_sample), ride_volume(83000, cb_sample), ride_volume(90000, cb_sample), ride_volume(93000, cb_sample), ride_volume(100000, cb_sample),ride_volume(103000, cb_sample), ride_volume(110000, cb_sample), ride_volume(113000, cb_sample), ride_volume(120000, cb_sample), ride_volume(123000, cb_sample), ride_volume(130000, cb_sample), ride_volume(133000, cb_sample), ride_volume(140000, cb_sample), ride_volume(143000, cb_sample), ride_volume(150000, cb_sample), ride_volume(153000, cb_sample), ride_volume(160000, cb_sample),ride_volume(163000, cb_sample), ride_volume(170000, cb_sample), ride_volume(173000, cb_sample), ride_volume(180000, cb_sample), ride_volume(183000, cb_sample), ride_volume(190000, cb_sample), ride_volume(193000, cb_sample), ride_volume(200000, cb_sample),ride_volume(203000, cb_sample), ride_volume(210000, cb_sample), ride_volume(213000, cb_sample), ride_volume(220000, cb_sample), ride_volume(223000, cb_sample), ride_volume(230000, cb_sample),ride_volume(233000, cb_sample), ride_volume(240000, cb_sample))
hour_volume <- data.frame(hours, volumes)

ggplot(data = hour_volume, aes(x = hour_volume$hours, y = hour_volume$volumes)) + geom_line() + labs(title = "Ride Volume Throughout Average Day", x = "Time of Day", y = "Ride Volume (numbers of bikers)") + scale_x_continuous(breaks=seq(20000,240000,20000),labels=c( "2am","4am","6am", "8am", "10am","12pm","2pm", "4pm","6pm","8pm","10pm","12am")) + theme(axis.title.x = element_text(vjust=0))


#DAY OF THE WEEK
weekdays <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
cb$weekday <- as.character(cb$weekday)
ride_volume2 <- function(weekday1, cb){
  volume <- nrow(subset(cb, cb$weekday == weekday1))
  volume
}
volumes <- c(ride_volume2("Sunday", cb_sample),  ride_volume2("Monday", cb_sample), ride_volume2("Tuesday", cb_sample), ride_volume2("Wednesday", cb_sample), ride_volume2("Thursday", cb_sample), ride_volume2("Friday", cb_sample), ride_volume2("Saturday", cb_sample)) 
week_volume <- data.frame(weekdays, volumes)

op <- par(mar = c(8,5,5,1) + 0.1)
barplot(week_volume$volumes, names.arg = week_volume$weekdays, las=2, ylim = c(0,1000), ylab = "Ride Volume (numbers of bikers)", main = "Ride Volume Throughout Week" )
par(op)


#month
seasons <- c("Summer", "Spring", "Winter", "Fall")
ride_volume3 <- function(season1, cb){
  volume <- nrow(subset(cb, cb$season == season1))
  volume
}
volumes <- c(ride_volume3("Summer", cb_sample),  ride_volume3("Spring", cb_sample), ride_volume3("Winter", cb_sample), ride_volume3("Fall", cb_sample)) 
season_volume <- data.frame(seasons, volumes)
barplot(season_volume$volumes, names.arg = season_volume$seasons, las=2, ylim = c(0,2500), ylab = "Ride Volume (number of bikers)", main = "Ride Volume Throughout Seasons" )


```

###Question 2 Part C

Below are the top 20 stations originating the longest trip durations, across all time frames.
```{r,echo=FALSE}
#Question 2 Part C

cb = as.data.frame(cb)

longrides <- tapply(cb$tripduration, cb$start.station.name, mean)
longrides2 <- tail(sort(longrides),20)
longrides2 = as.data.frame(longrides2)
rownamesall <- row.names(longrides2)


longridesmorning <- subset(cb,cb$timeCategory=="Morning")
longridesmorning2 <- tapply(longridesmorning$tripduration, longridesmorning$start.station.name, mean)
longridesmorning2 <- tail(sort(longridesmorning2),20)
longridesmorning2 = as.data.frame(longridesmorning2)
longridesmorning2$longridesmorning2 <- factor(longridesmorning2$longridesmorning2, levels = longridesmorning2$longridesmorning2[order(longridesmorning2$longridesmorning2)])
longridesmorning2$longridesmorning2 = as.numeric(longridesmorning2$longridesmorning2)
rownamesmorning <- row.names(longridesmorning2)

longridesevening <- subset(cb,cb$timeCategory=="Evening")
longridesevening2 <- tapply(longridesevening$tripduration, longridesevening$start.station.name, mean)
longridesevening2 <- tail(sort(longridesevening2),20)

longridesevening2 = as.data.frame(longridesevening2)
longridesevening2$longridesevening2 <- factor(longridesevening2$longridesevening2, levels = longridesevening2$longridesevening2[order(longridesevening2$longridesevening2)])
longridesevening2$longridesevening2 = as.numeric(longridesevening2$longridesevening2)
rownamesevening <- row.names(longridesevening2)

longridesafternoon <- subset(cb,cb$timeCategory=="Afternoon")
longridesafternoon2 <- tapply(longridesafternoon$tripduration, longridesafternoon$start.station.name, mean)
longridesafternoon2 <- tail(sort(longridesafternoon2),20)
View(longridesafternoon2)

longridesafternoon2 = as.data.frame(longridesafternoon2)
longridesafternoon2$longridesafternoon2 <- factor(longridesafternoon2$longridesafternoon2, levels = longridesafternoon2$longridesafternoon2[order(longridesafternoon2$longridesafternoon2)])
longridesafternoon2$longridesafternoon2 = as.numeric(longridesafternoon2$longridesafternoon2)
rownamesafternoon <- row.names(longridesafternoon2)

```

```{r,echo=FALSE}
#plotting graphs
op <- par(mar = c(5,15,5,1) + 0.1)
op2 <- par(mgp=c(2.5,1,0))

barplot(longrides2$longrides2, names.arg = rownamesall, las=1,horiz=TRUE, main= "Top 20 Longest Average \n Trip Durations by Station", xlab = "Average Trip Duration (1000s seconds)")
par(op)
par(op2)
```


```{r,echo=FALSE}
#data to calculate venn diagram below:
rownamesall = as.factor(rownamesall)
rownamesmorning = as.factor(rownamesmorning)
rownamesevening = as.factor(rownamesevening)
rownamesafternoon = as.factor(rownamesafternoon)

#morning and evening
morningNevening <- intersect(rownamesmorning,rownamesevening)
morningNevening = as.factor(morningNevening)
morningNevening2 <- nlevels(morningNevening)

#morning and afternoon
morningNafternoon <- intersect(rownamesmorning,rownamesafternoon)
morningNafternoon = as.factor(morningNafternoon)
morningNafternoon2 <- nlevels(morningNafternoon)
#morning and all
morningNall <- intersect(rownamesmorning,rownamesall)
morningNall = as.factor(morningNall)
morningNall2 <- nlevels(morningNall)

#evening and afternoon
eveningNafternoon <- intersect(rownamesevening,rownamesafternoon)
eveningNafternoon = as.factor(eveningNafternoon)
eveningNafternoon2 <- nlevels(eveningNafternoon)
#evening and all
eveningNall <- intersect(rownamesevening,rownamesall)
eveningNall = as.factor(eveningNall)
eveningNall2 <- nlevels(eveningNall)

#afternoon and all
afternoonNall <- intersect(rownamesafternoon,rownamesall)
afternoonNall = as.factor(afternoonNall)
afternoonNall2 <- nlevels(afternoonNall)


#morning, evening, and afternoon
MENA <- Reduce(intersect, list(rownamesmorning,rownamesevening,rownamesafternoon))
MENA = as.factor(MENA)
MENA2 <-nlevels(MENA)

#morning, evening, and all
MENAll <- Reduce(intersect, list(rownamesmorning,rownamesevening,rownamesall))
MENAll = as.factor(MENAll)
MENAll2 <- nlevels(MENAll)

#morning, afternoon, and all
MANAll <- Reduce(intersect, list(rownamesmorning,rownamesafternoon,rownamesall))
MANAll = as.factor(MANAll)
MANAll2 <- nlevels(MANAll)
#evening, afternoon, and all
EANAll <- Reduce(intersect, list(rownamesevening,rownamesafternoon,rownamesall))
EANAll = as.factor(EANAll)
EANAll2 <- nlevels(EANAll)

#all 4
ALLFOUR <-Reduce(intersect, list(rownamesmorning,rownamesevening,rownamesafternoon,rownamesall))
ALLFOUR = as.factor(ALLFOUR)
ALLFOUR2 <- nlevels(ALLFOUR)

#morning only
morningonly <- 20-morningNall2-morningNevening2 - morningNafternoon2 - MENA2 - MENAll2 - MANAll2 - ALLFOUR2
#evening only
eveningonly <- 20-morningNevening2 - eveningNafternoon2 - eveningNall2 - MENA2 - MENAll2 - EANAll2- ALLFOUR2
#afternoon only
afternoononly <- 20 - morningNafternoon2 - eveningNafternoon2 - afternoonNall2 - MENA2 - MANAll2-EANAll2- ALLFOUR2
#all only
allonly <- 20- morningNall2 - eveningNall2 - afternoonNall2 - MENAll2 - MANAll2 - EANAll2- ALLFOUR2
```

This Venn diagram displays the overlaps between top 20 stations originating the longest trip druations, across time frames. We can clearly see that the top 20 stations changes significantly as the time of day changes.

Some stations are only within the top 20 busiest stations list during a designated time frame (e.g., morning, evening, afternoon), whereas other stations are busy across multiple time frames (e.g., morning and afternoon). No stations are in the top 20 busiest stations list for the entire day (i.e., morning to afternoon to evening.
```{r,echo=FALSE}
venn.plot <- draw.quad.venn(20, 20, 20, 20, morningNafternoon2, morningNevening2, morningNall2, eveningNafternoon2, afternoonNall2,
eveningNall2, MENA2, MANAll2, MENAll2, EANAll2, ALLFOUR2, category = c("Morning","Afternoon", "Evening", "All"), lwd = rep(2, 4), lty = rep("solid", 4), col =
rep("black", 4), fill = c("blue","red","green","yellow"), alpha = rep(0.5, 4),
label.col = rep("black", 15), cex = rep(1, 15),
fontface = rep("bold", 15), fontfamily = rep("serif",
15), cat.pos = c(-15, 15, 0, 0), cat.dist = c(0.22,
0.22, 0.11, 0.11), cat.col = rep("black", 4), cat.cex
= rep(1, 4), cat.fontface = rep("bold", 4),
cat.fontfamily = rep("serif", 4), cat.just =
rep(list(c(0.5, 0.5)), 4), rotation.degree = 0,
rotation.centre = c(0.5, 0.5), ind = TRUE, cex.prop =
NULL, print.mode = "raw", sigdigs = 3, direct.area =
FALSE, area.vector = 0)
```



Below we can compare the specific stations comprising the top 20 stations originating the longest rides, in each time frame.
```{r,echo=FALSE}
rownamesall <- rownamesall[order(rownamesall)]
rownamesmorning <- rownamesmorning[order(rownamesmorning)]
rownamesafternoon <- rownamesafternoon[order(rownamesafternoon)]
rownamesevening <- rownamesevening[order(rownamesevening)]

toptimesdf <- data.frame(rownamesall,rownamesmorning,rownamesafternoon, rownamesevening)

names(toptimesdf)[names(toptimesdf)=="rownamesall"] <- "All data"
names(toptimesdf)[names(toptimesdf)=="rownamesmorning"] <- "Morning data"
names(toptimesdf)[names(toptimesdf)=="rownamesevening"] <- "Evening data"
names(toptimesdf)[names(toptimesdf)=="rownamesafternoon"] <- "Afternoon data"



toptimestable <-kable(toptimesdf, format = "markdown")

toptimestable
#NEED TO VERIFY THESE NUMBERS
```

In the below barcharts, we can see that the top 20 stations originating the longest trip durations generate similar distributions in average trip duration.


```{r,echo=FALSE}
op <- par(mar = c(5,15,5,1) + 0.1)
op2 <- par(mgp=c(2.5,1,0))

barplot(longridesmorning2$longridesmorning2, names.arg = rownamesmorning, las=1, horiz=TRUE, main="Top 20 Longest Average Morning \n Trip Durations by Station", xlab="Average Trip Duration (1000s seconds)")

barplot(longridesevening2$longridesevening2, names.arg = rownamesevening, las=1, horiz=TRUE, main="Top 20 Longest Average Evening \n Trip Durations by Station", xlab="Average Trip Duration (1000s seconds)")

barplot(longridesafternoon2$longridesafternoon2, names.arg = rownamesafternoon, las=1, horiz=TRUE, main="Top 20 Longest Average Afternoon \n Trip Durations by Station", xlab="Average Trip Duration (1000s seconds)")
par(op)
par(op2)

```



#Question 3

```{r}

library(leaflet)

cb_sample <- sample_n(cb, 5000)

leaflet(data = cb_sample) %>% addTiles() %>%
  addMarkers(~cb_sample$end.station.longitude, ~cb_sample$start.station.latitude, popup = ~cb_sample$start.station.name, clusterOptions = markerClusterOptions()) %>%   addProviderTiles("CartoDB.Positron")

```

#Question 4

```{r}

cb_sample <- sample_n(cb, 50000)

subscribers <- subset(cb_sample, cb_sample$usertype == "Subscriber")
subscribers$subscriber <- 1
subscriber_count <- data.frame(tapply(subscribers$subscriber, subscribers$start.station.name, sum))

subscriber_count <- na.omit(subscriber_count)
names <- rownames(subscriber_count)
rownames(subscriber_count) <- NULL
subscriber_count <- cbind(names, subscriber_count)
colnames(subscriber_count) <- c("station.name", "subscribers")

subscriber_count$lat <- cb_sample$start.station.latitude[subscriber_count$station.name]
subscriber_count$lng <- cb_sample$start.station.longitude[subscriber_count$station.name]


leaflet(subscriber_count) %>% addTiles() %>%
  addCircles(lng = ~subscriber_count$lng, lat = ~subscriber_count$lat, weight = 1,
    radius = ~subscriber_count$subscribers, popup = paste(subscriber_count$station.name, "<br/>", "Subscribers: ",subscriber_count$subscribers)
  ) %>%   addProviderTiles("CartoDB.Positron")

```

#Question 5

```{r}

cb_sample <- sample_n(cb, 100)

duration_averages <- data.frame(tapply(cb_sample$tripduration, cb_sample$start.station.name, mean, na.rm = TRUE))
duration_averages <- na.omit(duration_averages)
names <- rownames(duration_averages)
rownames(duration_averages) <- NULL
duration_averages <- cbind(names, duration_averages)
colnames(duration_averages) <- c("station.name", "average.duration")
duration_averages$lat <- cb_sample$start.station.latitude[duration_averages$station.name]
duration_averages$lng <- cb_sample$start.station.longitude[duration_averages$station.name]

leaflet(duration_averages) %>% addTiles() %>%
  addCircles(lng = ~duration_averages$lng, lat = ~duration_averages$lat, weight = 1,
    radius = ~duration_averages$average.duration/2, popup =  paste(duration_averages$station.name, "<br/>", "Average Trip Duration: ", duration_averages$average.duration, " seconds")
  ) %>%   addProviderTiles("CartoDB.Positron")


```

